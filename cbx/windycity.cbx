% Last modified: Thu 13 Dec 2018 05:24:57 PM CST

% Copyright (c) 2018 Brian Michael Chase.
%
% Permission is granted to copy, distribute and/or modify this
% software under the terms of the LaTeX Project Public License (LPPL),
% version 1.3.
%
% The LPPL maintenance status of this software is 'author-maintained'.
%
% This software is provided 'as is', without warranty of any kind,
% either expressed or implied, including, but not limited to, the
% implied warranties of merchantability and fitness for a particular
% purpose.

\ProvidesFile{windycity.cbx}[Windy City style for biblatex]

\@ifpackagelater{biblatex}{2017/11/04}
   {}
   {\PackageError{biblatex}
      {Outdated 'biblatex' package}
      {Windy City 2018.12.09 is for biblatex v3.8 and above.\MessageBreak
       You are using: '\csuse{ver@biblatex.sty}'.\MessageBreak
       This is a fatal error. I'm aborting now.}%
    \endinput}%
\RequireBiber

% This file contains material only for formatting notes and
% parenthetical citations. For content that is also used for
% bibliographies and reference lists, see windycity.bbx.

%%%%%%%%%%%%%%%%%%%
%%  Preliminary  %%
%%%%%%%%%%%%%%%%%%%

\InitializeCitationStyle{\let\crossreflist\empty}%
\AtEveryCite{%
  \global\togglefalse{bibliography}%
  \global\togglefalse{multicite}%
  \global\togglefalse{multivolume}%
  \global\togglefalse{cbx@first}%
  \global\togglefalse{cbx@loccit}%
  \AtEveryItem}%
\AtEveryMultiCite{\toggletrue{multicite}}%

% To facilitate uniform output, citations in notes always end with
% '\addperiod' (see cite:postnote). This makes '\footcite{something}'
% and '\footnote{\cite{something}}' functionally equivalent. To
% prevent an extra period from printing in very rare cases, as when
% the text of '\footcite{something}' ends with a capital letter,
% remove '\addperiod' from the commands below:

\renewcommand{\bibfootnotewrapper}[1]{%
  \bibsentence#1}%
\renewcommand{\bibendnotewrapper}[1]{%
  \bibsentence#1}%

%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Citation Commands  %%
%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareCiteCommand{\bibentry}
  {}
  {\citetrackerfalse
   \AtBeginLists
   \usedriver
     {\DeclareNameAlias{author}{sortname}}%
     {\thefield{entrytype}}%
   \finentry}%
  {}{}

\DeclareCiteCommand{\cite}
  {\usebibmacro{prenote}}%
  {\usebibmacro{citeindex}%
   \usebibmacro{cite}}%
  {\multicitedelim}%
  {\usebibmacro{cite:postnote}}%

\DeclareCiteCommand*{\cite}
  {\usebibmacro{prenote}}%
  {\usebibmacro{citeindex}%
   \toggletrue{noauth}%
   \usebibmacro{cite}}%
  {\multicitedelim}%
  {\usebibmacro{cite:postnote}}%

\providetoggle{reprinted}
\DeclareCiteCommand{\reprint}
  {}
  {\usebibmacro{citeindex}%
   \toggletrue{noauth}%
   \toggletrue{reprinted}%
   \bibsentence\bibstring{reprinted}\space
   \usebibmacro{cite}%
   \togglefalse{reprinted}}%
  {\multicitedelim}%
  {\usebibmacro{cite:postnote}}%

\DeclareCiteCommand{\crossref}
  {}
  {\printnames{labelname}%
   \setunit{\addcomma\space}%
   \printfield{labeltitle}}%
  {}{}%

\DeclareCiteCommand{\footcite}[\mkbibfootnote]
  {\bibsentence\usebibmacro{prenote}}%
  {\usebibmacro{citeindex}%
   \usebibmacro{cite}}%
  {\multicitedelim}%
  {\usebibmacro{cite:postnote}}%

\DeclareCiteCommand*{\footcite}[\mkbibfootnote]
  {\bibsentence\usebibmacro{prenote}}%
  {\usebibmacro{citeindex}%
   \toggletrue{noauth}%
   \usebibmacro{cite}}%
  {\multicitedelim}%
  {\usebibmacro{cite:postnote}}%

\DeclareCiteCommand{\fullcite}
  {\usebibmacro{prenote}}%
  {\citetrackerfalse
   \usebibmacro{citeindex}%
   \global\toggletrue{cbx@first}%
   \usebibmacro{cite:long}}%
  {\multicitedelim}%
  {\usebibmacro{cite:postnote}}%

\DeclareCiteCommand*{\fullcite}
  {\usebibmacro{prenote}}%
  {\citetrackerfalse
   \usebibmacro{citeindex}%
   \global\toggletrue{cbx@first}%
   \toggletrue{noauth}%
   \usebibmacro{cite:long}}%
  {\multicitedelim}%
  {\usebibmacro{cite:postnote}}%

\DeclareCiteCommand{\parencite}[\mkbibparens]
  {\usebibmacro{prenote}}%
  {\usebibmacro{citeindex}%
   \usebibmacro{parencite}}%
  {\multicitedelim}%
  {\usebibmacro{pcite:postnote}}%

\DeclareCiteCommand*{\parencite}[\mkbibparens]
  {\usebibmacro{prenote}}%
  {\usebibmacro{citeindex}%
   \toggletrue{noauth}%
   \usebibmacro{parencite}}%
  {\multicitedelim}%
  {\usebibmacro{pcite:postnote}}%

\DeclareCiteCommand{\refentry}
  {}
  {\citetrackerfalse
   \AtBeginLists
   \global\toggletrue{reflist}%
   \usedriver
     {\DeclareNameAlias{author}{sortname}}%
     {\thefield{entrytype}}%
   \global\togglefalse{reflist}%
   \finentry}%
  {}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Parenthetical Citations  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newbibmacro*{parencite}{%
  \ifciteseen
    {\ifboolexpr{ test \ifciteibid
                  and togl {short}
                  and not test \iffirstonpage}
       {\usebibmacro{pcite:labelyear+etc}}%
       {\iffieldundef{shorthand}
          {\usebibmacro{pcite:labelname+labeltitle}%
           \usebibmacro{pcite:labelyear+extradate}}%
          {\usebibmacro{cite:shorthand}}}}
    {\usebibmacro{pcite:long}}}

\newbibmacro*{pcite:labelyear+etc}{%
  \iffieldundef{postnote}
    {\usebibmacro{pcite:labelyear+extradate}}%
    {}}

\newbibmacro*{pcite:labelname+labeltitle}{%
  \iftoggle{noauth}
    {}
    {\ifboolexpr{ test {\ifnameundef{labelname}}
                  or test {\iffieldundef{labelyear}}}
       {\iffieldundef{label}
          {\ifentrytype{article}
            {\renewcommand*{\xtitle}{journal}%
             \usebibmacro{longtitle}}%
            {\printtext[bibhyperref]{\printfield[citetitle]{labeltitle}}}}
          {\printtext[bibhyperref]{\printfield{label}}}% needs these '%'
        \setunit{\space}}%
       {\global\toggletrue{cbx@short}%
        \renewcommand*{\cbx@deflabel}{labelname}%
        \clearfield{nameaddon}%
        \usebibmacro{author+bookauthor+etc}%
        \setunit{\space}}}}

\newbibmacro*{pcite:labelyear+extradate}{%
  \iffieldundef{labelyear}
    {}
    {\usebibmacro{pcite:origyear}%
     \ifboolexpr{ test {\iffieldnum{year}}
                  or test {\iffieldnums{year}}}
      {}
      {\addcomma}%
     \printtext[bibhyperref]{%
       \printfield{labelyear}%
       \printfield{extradate}}}}

\newbibmacro*{pcite:long}{%
  \global\toggletrue{cbx@first}%
  \usebibmacro{pcite:labelname+labeltitle}%
  \usebibmacro{pcite:labelyear+extradate}}%

\newbibmacro*{pcite:origyear}{%
  \iffieldundef{origyear}
    {}
    {\printfield[brackets]{origyear}%
     \space}}%

\newbibmacro*{pcite:postnote}{%
  \newunit
  \usebibmacro{cite:vol+page}%
  \iftoggle{cbx@first}
    {\usebibmacro{cite:pages}%
     \usebibmacro{postnote}%
     \iffieldundef{shorthand}
       {}
       {\setunit{\addsemicolon\space}%
        \bibstring{citedas}%
        \addcomma\space
        \usebibmacro{cite:shorthand}}}
    {\usebibmacro{postnote}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Citations in Notes  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%

\newbibmacro*{cite}{%
  \usebibmacro{test:multicite}%
  \usebibmacro{test:multivolume}%
  \ifciteseen
    {\renewcommand*{\cbx@deflabel}{labelname}%
     \iffieldundef{shorthand}
       {\ifboolexpr{ test \ifciteibid
                     and togl {short}
                     and not test \iffirstonpage}
          {\usebibmacro{cite:ibid}}%
          {\usebibmacro{cite:short}}}
       {\usebibmacro{cite:shorthand}}}
    {\usebibmacro{cite:new}}%
  \usebibmacro{savefields}}%

\newbibmacro*{test:multicite}{%
  \ifboolexpr{ test {\iffieldequals{namehash}{\bbx@lasthash}}
               and togl {multicite}
               and togl {short}}
   {\toggletrue{noauth}}%
   {}}

\newbibmacro*{cite:ibid}{%
  \iftoggle{ibid}
    {\printtext[bibhyperref]{%
       \bibcpstring{ibidem}%
       \ifloccit
         {\global\toggletrue{cbx@loccit}}%
         {\usebibmacro{cite:vol+page}}}}
    {\global\toggletrue{cbx@short}%
     \ifentrytype{review}
       {\printtext[bibhyperref]{%
          \usebibmacro{cite:ibid:review}}}
       {\printtext[bibhyperref]{%
          \usebibmacro{author+bookauthor+etc}%
          \iftoggle{noauth}
            {\usebibmacro{title+labelyear}}%
            {}% needs this '%'
         \usebibmacro{cite:vol+page}}}}}

\newbibmacro*{cite:ibid:review}{%
  \ifnameundef{author}
    {\bibcpstring{reviewnoauth}%
     \space
     \usebibmacro{title+labelyear}}%
    {\usebibmacro{author+bookauthor+etc}}%
  \usebibmacro{cite:vol+page}}%

\newbibmacro*{cite:short}{%
  \global\toggletrue{cbx@short}%
  \ifentrytype{review}
    {\printtext[bibhyperref]{%
       \usebibmacro{cite:short:review}}}
    {\printtext[bibhyperref]{%
       \usebibmacro{author+bookauthor+etc}%
       \usebibmacro{title+labelyear}%
       \usebibmacro{cite:vol+page}}}}

\newbibmacro*{cite:short:review}{%
  \ifnameundef{author}
    {\bibcpstring{reviewnoauth}}%
    {\usebibmacro{author+bookauthor+etc}%
     \bibstring{review}}%
  \space
  \usebibmacro{test:title+booktitle}%
  \usebibmacro{title+labelyear}%
  \usebibmacro{cite:vol+page}}%

\newbibmacro*{cite:shorthand}{%
  \printtext[bibhyperref]{\printfield{shorthand}}}

\newbibmacro*{cite:new}{%
  \global\toggletrue{cbx@first}%
  \usebibmacro{deflabel}%
  \iftoggle{multivolume}
    {\usebibmacro{crossref+short+long}}%
    {\iftoggle{firstshort}
      {\usebibmacro{cite:short}}%
      {\usebibmacro{crossref+long}}}}

\newbibmacro*{savefields}{%
  \iffieldundef{crossref}
    {\let\cbx@keyhash\empty}%
    {\savefield{crossref}{\cbx@keyhash}}}

\newbibmacro*{deflabel}{%
  \ifboolexpr{ test {\ifciteidem}
               or togl {firstshort}}
    {\renewcommand*{\cbx@deflabel}{labelname}}%
    {\renewcommand*{\cbx@deflabel}{default}}}

\newbibmacro*{crossref+long}{%
  \iffieldundef{crossref}
    {\usebibmacro{cite:long}}%
    {\xifinlist{\thefield{crossref}}{\crossreflist}
       {\stepcounter{\thefield{crossref}}%
        \printtext{%
          \usedriver
            {\DeclareNameAlias{sortname}{default}}%
            {cite:crossref}}}
       {\listxadd{\crossreflist}{\thefield{crossref}}%
        \ifcsdef{c@\thefield{crossref}}
          {\setcounter{\thefield{crossref}}{0}}%
          {\newcounter{\thefield{crossref}}}
        \usebibmacro{cite:long}}}}

\newbibmacro*{cite:long}{%
  \printtext{%
    \usedriver
      {\DeclareNameAlias{sortname}{default}}%
      {cite:\thefield{entrytype}}}}

\newbibmacro*{crossref+short+long}{%
  \xifinlist{\thefield{crossref}}{\crossreflist}
    {\stepcounter{\thefield{crossref}}%
     \global\togglefalse{cbx@first}%
     \renewcommand*{\cbx@deflabel}{labelname}%
     \ifboolexpr{ test {\iffieldequals{crossref}{\cbx@keyhash}}
                  and togl {short}
                  and not test \iffirstonpage}
       {\usebibmacro{cite:ibid}}%
       {\usebibmacro{cite:short}}}
    {\listxadd{\crossreflist}{\thefield{crossref}}%
     \ifcsdef{c@\thefield{crossref}}
       {\setcounter{\thefield{crossref}}{0}}%
       {\newcounter{\thefield{crossref}}}
     \iftoggle{firstshort}
      {\usebibmacro{cite:short}}%
      {\usebibmacro{cite:long}}}}

\newbibmacro*{cite:postnote}{%
  \ifboolexpr{ togl {cbx@loccit}
               and togl {ibid}}
    {}
    {\iftoggle{cbx@first}
       {\usebibmacro{postnote:first}%
        \usebibmacro{shorthand+intro}}%
       {\usebibmacro{postnote}}}
  \iflastcitekey
    {\addperiod}%
    {}}

\renewbibmacro*{postnote}{%
  \iffieldundef{postnote}
    {}
    {\iftoggle{multivolume}
       {}
       {\newunit}%
     \printfield{postnote}}}

\newbibmacro*{postnote:first}{%
  \ifboolexpr{ test {\iffieldundef{postnote}}
               and test {\iffieldundef{pages}}
               and test {\iffieldundef{url}}}
    {\usebibmacro{doi+url+etc}}%
    {\usebibmacro{cite:pages}%
     \usebibmacro{postnote}%
     \usebibmacro{doi+url+etc}}}

\newbibmacro*{cite:vol+page}{%
  \ifboolexpr{ test {\ifentrytype{book}}
               or test {\ifentrytype{bookinbook}}
               or test {\ifentrytype{inbook}}
               or test {\ifentrytype{incollection}}}
    {\usebibmacro{vol+page}}%
    {\newunit}}%

\newbibmacro*{vol+page}{%
  \iffieldundef{volume}
    {}
    {\newunit
     \iffieldpages{postnote}
       {\global\toggletrue{multivolume}%
        \usebibmacro{vol+colon}}%
       {\printfield{volume}}}}

% If the postnote is empty, print the page ranges of journal articles.
% See CMS, 17th ed., 14.153, 14.167, and 14.174. As for incollection
% and inbook entries, 14.106 seems to suggest the same, but the
% example in 14.30 suggests otherwise For magazines, the range can be
% left out. To do so, simply omit it from your bibliography database.

\newbibmacro*{cite:pages}{%
  \iffieldundef{pages}
    {}
    {\ifboolexpr{ test {\ifentrytype{article}}
                  or test {\ifentrytype{review}}}
       {\iffieldundef{postnote}
          {\newunit
           \printfield{pages}}%
          {}}
       {}}}

% Use 'shorthandintro' to introduce a shorthand in whatever format you
% want. See the example in windycity.bib.

\newbibmacro*{shorthand+intro}{%
  \iffieldundef{shorthand}
    {}
    {\iffieldundef{shorthandintro}
       {\setunit{\addspace}%
        \printtext[parens]{%
          \bibstring{citedas}\space
          \usebibmacro{cite:shorthand}}}
       {\setunit{\addspace}%
        \printfield{shorthandintro}}}}

% Protect commas against abbreviation dots and terminal punctuation
% marks. Note '\addspace'. Using '\space' there causes problems.

\renewcommand*{\newunitpunct}{\ifterm{,\addspace}{\addcomma\space}}%

\newbibmacro*{colon}{%
  \ifboolexpr{ test {\iffieldundef{pages}}
               and test {\iffieldundef{postnote}}}
    {}
    {\ifboolexpr{ test {\iffieldundef{year}}
                  and test {\iffieldundef{month}}
                  and test {\iffieldundef{issue}}}
       {\setunit{\addcolon}}%
       {\ifboolexpr{ test {\iffieldundef{number}}
                     and test {\iffieldundef{volume}}}
          {\newunit}%
          {\setunit{\addcolon\space}}}}}

% The next two macros determine whether to treat a multivolume
% collection as a single work when you cite an InBook entry that
% cross-references a Collection entry. In those cases, citing pages
% prints the volume and pages together, separated by a colon, as in
% '4:243'. Following CMS 14.118, 17th ed., what matters is whether all
% volumes in the collection have the same publication date and title.
% To match apparent exceptions, like the second example in 14.59, cite
% the Collection entry and enter the volume and page in the postnote,
% such as '1:126'.

\newbibmacro*{test:multivolume}{%
  \ifentrytype{inbook}
    {\usebibmacro{test:multivolume:years}%
     \iffieldsequal{title}{booktitle}
       {\iffieldundef{volumetitle}
          {}
          {\global\togglefalse{multivolume}}}
       {\global\togglefalse{multivolume}}}
    {}}

\newbibmacro*{test:multivolume:years}{%
  \iffieldsequal{year}{bookyear}
    {\ifboolexpr{ test {\iffieldundef{endyear}}
                  and test {\iffieldundef{endbookyear}}}
       {\global\toggletrue{multivolume}}%
       {\iffieldsequal{endyear}{endbookyear}
          {\global\toggletrue{multivolume}}%
          {}}}
     {}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Bibliography Drivers for Notes  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareBibliographyDriver{cite:article}{%
  \usebibmacro{author+title+ed+note}%
  \usebibmacro{articles}%
  \usebibmacro{colon}}%

\DeclareBibliographyDriver{cite:book}{%
  \usebibmacro{author+title+ed}%
  \usebibmacro{ed+vol+part+etc}%
  \usebibmacro{vol+page}}%

\DeclareBibliographyDriver{cite:crossref}{%
  \usebibmacro{author+title+etc}%
  \crossref{\thefield{crossref}}%
  \newunit}%

\DeclareBibliographyDriver{cite:incollection}{%
  \usebibmacro{author+title+etc}%
  \usebibmacro{incollections}%
  \usebibmacro{vol+page}}%

\DeclareBibliographyDriver{cite:letter}{%
  \toggletrue{noauth}%
  \usebibmacro{author+title+etc}%
  \usebibmacro{incollections}%
  \usebibmacro{vol+page}}%

\DeclareBibliographyDriver{cite:misc}{%
  \usebibmacro{author+bookauthor+etc}%
  \usebibmacro{title+labelyear}%
  \newunit
  \printfield{usera}%
  \newunit}%

\DeclareBibliographyDriver{cite:online}{%
  \usebibmacro{author+title+ed+note}%
  \usebibmacro{note}%
  \printlist{institution}%
  \newunit
  \printlist{organization}%
  \newunit}%

\DeclareBibliographyDriver{cite:patent}{%
  \usebibmacro{author+title+ed+note}%
  \usebibmacro{note}%
  \printfield{number}%
  \newunit}%

\DeclareBibliographyDriver{cite:reference}{%
  \printlist{organization}%
  \usebibmacro{edition}%
  \ifboolexpr{ test {\iffieldundef{howpublished}}
               and test {\iffieldundef{year}}}
    {}
    {\space
     \iffieldundef{howpublished}
       {\printtext[parens]{\printfield{year}}}
       {\global\togglefalse{cbx@first}%
        \printtext[parens]{%
          \printfield{howpublished}%
          \newunit
          \printfield{version}%
          \newunit
          \printfield{year}}}}
  \newunit
  \bibstring{subverbo}\space
  \usebibmacro{longtitle+titleaddon}%
  \newunit
  \renewcommand*{\pluga}{\bibstring{by}\space}%
  \renewcommand*{\cbx@namelist}{author}%
  \usebibmacro{printnames+etc}}%

\DeclareBibliographyDriver{cite:review}{%
  \usebibmacro{reviews}%
  \usebibmacro{articles}%
  \usebibmacro{colon}}%

\DeclareBibliographyDriver{cite:thesis}{%
  \usebibmacro{author+title+ed+note}%
  \printtext[parens]{%
    \printfield{type}%
    \newunit
    \usebibmacro{inst+loc+date}}%
  \newunit}%

\endinput
